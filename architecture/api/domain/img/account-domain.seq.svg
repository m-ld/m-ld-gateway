<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="474px" preserveAspectRatio="none" style="width:793px;height:474px;background:#FFFFFF;" version="1.1" viewBox="0 0 793 474" width="793px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.4883" id="_title" style="stroke:none;stroke-width:1.0;" width="200" x="292.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="190" x="297.5" y="28.5352">App with Gateway account</text><rect fill="#FFFFFF" height="43.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="36" y="415.6133"/><rect fill="#FFFFFF" height="227.2168" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="151.0859"/><rect fill="#FFFFFF" height="153.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="640" y="195.707"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="41" x2="41" y1="90.4648" y2="467.9238"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="236" x2="236" y1="90.4648" y2="467.9238"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="356" x2="356" y1="90.4648" y2="467.9238"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="644.5" x2="644.5" y1="90.4648" y2="467.9238"/><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="54" x="14" y="42.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="27" y="63.0234">App</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="21" y="79.5117">Client</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="126" x="173" y="58.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="180" y="79.5117">Identity Provider</text><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="309" y="42.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="80" x="316" y="63.0234">App Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="321" y="79.5117">or lambda</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="609.5" y="58.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="616.5" y="79.5117">Gateway</text><rect fill="#FFFFFF" height="43.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="36" y="415.6133"/><rect fill="#FFFFFF" height="227.2168" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="151.0859"/><rect fill="#FFFFFF" height="153.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="640" y="195.707"/><polygon fill="#181818" points="52,117.7754,42,121.7754,52,125.7754,48,121.7754" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="224,117.7754,234,121.7754,224,125.7754,228,121.7754" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="46" x2="230" y1="121.7754" y2="121.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="58" y="117.0332">Authenticate user (or anon)</text><polygon fill="#181818" points="339,147.0859,349,151.0859,339,155.0859,343,151.0859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="41" x2="345" y1="151.0859" y2="151.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="48" y="146.3438">get config for subdomain {userId}</text><polygon fill="#181818" points="628,191.707,638,195.707,628,199.707,632,195.707" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="361" x2="634" y1="195.707" y2="195.707"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="368" y="175.6543">PUT /domain/&lt;&lt;account&gt;&gt;/&lt;&lt;name&gt;&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="368" y="190.9648">{authKey, userId}</text><line style="stroke:#181818;stroke-width:1.0;" x1="650" x2="692" y1="240.3281" y2="240.3281"/><line style="stroke:#181818;stroke-width:1.0;" x1="692" x2="692" y1="240.3281" y2="253.3281"/><line style="stroke:#181818;stroke-width:1.0;" x1="651" x2="692" y1="253.3281" y2="253.3281"/><polygon fill="#181818" points="661,249.3281,651,253.3281,661,257.3281,657,253.3281" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="657" y="220.2754">Create user JWT,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="657" y="235.5859">sign with authKey</text><polygon fill="#181818" points="372,344.9922,362,348.9922,372,352.9922,368,348.9922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="366" x2="644" y1="348.9922" y2="348.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="378" y="344.25">config for new clones</text><path d="M5,266.3281 L5,351.3281 L346,351.3281 L346,276.3281 L336,266.3281 L5,266.3281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M336,266.3281 L336,276.3281 L346,276.3281 L336,266.3281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="11" y="283.395">{</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="304" x="27" y="298.5278">@domain:"«name».«account».«hostname»",</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="104" x="27" y="313.6606">genesis:true,</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="27" y="328.7935">io: { auth: { jwt } }</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="11" y="343.9263">}</text><path d="M655,281.1943 L655,336.1943 L786,336.1943 L786,291.1943 L776,281.1943 L655,281.1943 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M776,281.1943 L776,291.1943 L786,291.1943 L776,281.1943 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="661" y="298.7627">if backup clone</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="661" y="314.0732">or domain exists,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="661" y="329.3838">genesis is false</text><polygon fill="#181818" points="52,374.3027,42,378.3027,52,382.3027,48,378.3027" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="46" x2="355" y1="378.3027" y2="378.3027"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="58" y="373.5605">config</text><line style="stroke:#181818;stroke-width:1.0;" x1="41" x2="88" y1="402.6133" y2="402.6133"/><line style="stroke:#181818;stroke-width:1.0;" x1="88" x2="88" y1="402.6133" y2="415.6133"/><line style="stroke:#181818;stroke-width:1.0;" x1="47" x2="88" y1="415.6133" y2="415.6133"/><polygon fill="#181818" points="57,411.6133,47,415.6133,57,419.6133,53,415.6133" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="53" y="397.8711">Create clone</text><polygon fill="#181818" points="57,445.9238,47,449.9238,57,453.9238,53,449.9238" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="633,445.9238,643,449.9238,633,453.9238,637,449.9238" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="51" x2="639" y1="449.9238" y2="449.9238"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="63" y="445.1816">socket.io remotes</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="40" x="180" y="444.8579">{jwt}</text><!--MD5=[49e43c5ee9d22d719b0275b9c6078ff7]
@startuml
'https://plantuml.com/sequence-diagram
hide footbox

title App with Gateway account

participant "App\nClient" as client
participant "Identity Provider" as idp
participant "App Service\nor lambda" as service

client <- -> idp: Authenticate user (or anon)
client -> service ++ : get config for subdomain {userId}
service -> Gateway ++: PUT /domain/<<account>>/<<name>>\n{authKey, userId}
Gateway -> Gateway: Create user JWT,\nsign with authKey
return config for new clones
note left
<code>
{
  @domain:"<<name>>.<<account>>.<<hostname>>",
  genesis:true,
  io: { auth: { jwt } }
}
</code>
end note
note right
if backup clone
or domain exists,
genesis is false
end note
return config
client -> client ++: Create clone
client <- -> Gateway: socket.io remotes ""{jwt}""

@enduml

@startuml
hide footbox

title App with Gateway account

participant "App\nClient" as client
participant "Identity Provider" as idp
participant "App Service\nor lambda" as service

client <- -> idp: Authenticate user (or anon)
client -> service ++ : get config for subdomain {userId}
service -> Gateway ++: PUT /domain/<<account>>/<<name>>\n{authKey, userId}
Gateway -> Gateway: Create user JWT,\nsign with authKey
return config for new clones
note left
<code>
{
  @domain:"<<name>>.<<account>>.<<hostname>>",
  genesis:true,
  io: { auth: { jwt } }
}
</code>
end note
note right
if backup clone
or domain exists,
genesis is false
end note
return config
client -> client ++: Create clone
client <- -> Gateway: socket.io remotes ""{jwt}""

@enduml

PlantUML version 1.2022.8(Sun Sep 25 10:00:33 BST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>