<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg"
     contentStyleType="text/css" height="922px" preserveAspectRatio="none"
     style="width:679px;height:922px;background:#FFFFFF;" version="1.1" viewBox="0 0 679 922"
     width="679px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="873.207" style="stroke:#181818;stroke-width:0.5;" width="218" x="356" y="43.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="451" y="56.0566">App</text><rect fill="none" height="26.4883" id="_title" style="stroke:none;stroke-width:1.0;" width="177" x="366" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="167" x="371" y="28.5352">More Concurrent Cases</text><rect fill="none" height="296.1055" style="stroke:#000000;stroke-width:1.5;" width="501" x="85" y="106.2871"/><rect fill="none" height="466.3027" style="stroke:#000000;stroke-width:1.5;" width="665" x="8" y="420.3926"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="152" x2="152" y1="94.2871" y2="548.6348"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="152" x2="152" y1="548.6348" y2="589.5898"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="152" x2="152" y1="589.5898" y2="800.0742"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="152" x2="152" y1="800.0742" y2="828.0742"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="152" x2="152" y1="828.0742" y2="910.6953"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="154.9082"/><rect fill="#FFFFFF" height="79.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="255.8398"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="365.082"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="469.0137"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="762.7637"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="147" y="849.3848"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="401" x2="401" y1="94.2871" y2="548.6348"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="401" x2="401" y1="548.6348" y2="589.5898"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="401" x2="401" y1="589.5898" y2="800.0742"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="401" x2="401" y1="800.0742" y2="828.0742"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="401" x2="401" y1="828.0742" y2="910.6953"/><rect fill="#FFFFFF" height="273.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="396" y="133.5977"/><rect fill="#FFFFFF" height="100.9316" style="stroke:#FFFFFF;stroke-width:1.0;" width="10" x="396" y="447.7031"/><line style="stroke:#181818;stroke-width:1.0;" x1="396" x2="396" y1="447.7031" y2="548.6348"/><line style="stroke:#181818;stroke-width:1.0;" x1="406" x2="406" y1="447.7031" y2="548.6348"/><line style="stroke:#181818;stroke-width:1.0;" x1="396" x2="406" y1="447.7031" y2="447.7031"/><rect fill="#FFFFFF" height="210.4844" style="stroke:#FFFFFF;stroke-width:1.0;" width="10" x="396" y="589.5898"/><line style="stroke:#181818;stroke-width:1.0;" x1="396" x2="396" y1="589.5898" y2="800.0742"/><line style="stroke:#181818;stroke-width:1.0;" x1="406" x2="406" y1="589.5898" y2="800.0742"/><rect fill="#FFFFFF" height="63.6211" style="stroke:#FFFFFF;stroke-width:1.0;" width="10" x="396" y="828.0742"/><line style="stroke:#181818;stroke-width:1.0;" x1="396" x2="396" y1="828.0742" y2="891.6953"/><line style="stroke:#181818;stroke-width:1.0;" x1="406" x2="406" y1="828.0742" y2="891.6953"/><line style="stroke:#181818;stroke-width:1.0;" x1="396" x2="406" y1="891.6953" y2="891.6953"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="529" x2="529" y1="94.2871" y2="548.6348"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="529" x2="529" y1="548.6348" y2="589.5898"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="529" x2="529" y1="589.5898" y2="800.0742"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="529" x2="529" y1="800.0742" y2="828.0742"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="529" x2="529" y1="828.0742" y2="910.6953"/><rect fill="#FFFFFF" height="114.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="524" y="234.5293"/><rect fill="#FFFFFF" height="194.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="524" y="610.9004"/><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="116.5" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="123.5" y="83.334">Gateway</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="360" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="367" y="83.334">(thread 1)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="488" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="495" y="83.334">(thread 2)</text><path d="M85,106.2871 L289,106.2871 L289,113.5977 L279,123.5977 L85,123.5977 L85,106.2871 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="296.1055" style="stroke:#000000;stroke-width:1.5;" width="501" x="85" y="106.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="155" x="100" y="119.8555">concurrent write &amp; poll</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="41" x="304" y="118.9219">[happy]</text><polygon fill="#181818" points="168,150.9082,158,154.9082,168,158.9082,164,154.9082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="395" y1="154.9082" y2="154.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="174" y="150.166">POST ~/state { ... }</text><polygon fill="#181818" points="384,180.2188,394,184.2188,384,188.2188,388,184.2188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="390" y1="184.2188" y2="184.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="164" y="179.4766">200 OK ETag: "1" Update 1</text><line style="stroke:#181818;stroke-width:1.0;" x1="406" x2="448" y1="213.5293" y2="213.5293"/><line style="stroke:#181818;stroke-width:1.0;" x1="448" x2="448" y1="213.5293" y2="226.5293"/><line style="stroke:#181818;stroke-width:1.0;" x1="407" x2="448" y1="226.5293" y2="226.5293"/><polygon fill="#181818" points="417,222.5293,407,226.5293,417,230.5293,413,226.5293" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="413" y="208.7871">process Update 1</text><polygon fill="#181818" points="168,251.8398,158,255.8398,168,259.8398,164,255.8398" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="523" y1="255.8398" y2="255.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="174" y="251.0977">GET /updates</text><path d="M106,268.8398 L106,308.8398 L198,308.8398 L198,278.8398 L188,268.8398 L106,268.8398 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M188,268.8398 L188,278.8398 L198,278.8398 L188,268.8398 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="112" y="286.4082">Update 1 is</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="112" y="301.7188">pending</text><polygon fill="#181818" points="512,331.7715,522,335.7715,512,339.7715,516,335.7715" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="518" y1="335.7715" y2="335.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="164" y="331.0293">425 Too Early</text><polygon fill="#181818" points="168,361.082,158,365.082,168,369.082,164,365.082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="395" y1="365.082" y2="365.082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="174" y="360.3398">DELETE ~/state/lock If-Match: "1"</text><polygon fill="#181818" points="384,390.3926,394,394.3926,384,398.3926,388,394.3926" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="390" y1="394.3926" y2="394.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="164" y="389.6504">200 OK</text><path d="M8,420.3926 L225,420.3926 L225,427.7031 L215,437.7031 L8,437.7031 L8,420.3926 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="466.3027" style="stroke:#000000;stroke-width:1.5;" width="665" x="8" y="420.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="168" x="23" y="433.9609">timeout write processing</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="55" x="240" y="433.0273">[unhappy]</text><polygon fill="#181818" points="168,465.0137,158,469.0137,168,473.0137,164,469.0137" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="395" y1="469.0137" y2="469.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="174" y="464.2715">POST ~/state { ... }</text><polygon fill="#181818" points="384,494.3242,394,498.3242,384,502.3242,388,498.3242" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="390" y1="498.3242" y2="498.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="164" y="493.582">200 OK: Update 1</text><line style="stroke:#181818;stroke-width:1.0;" x1="406" x2="448" y1="527.6348" y2="527.6348"/><line style="stroke:#181818;stroke-width:1.0;" x1="448" x2="448" y1="527.6348" y2="540.6348"/><line style="stroke:#181818;stroke-width:1.0;" x1="407" x2="448" y1="540.6348" y2="540.6348"/><polygon fill="#181818" points="417,536.6348,407,540.6348,417,544.6348,413,540.6348" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="413" y="522.8926">process Update 1</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="181" x="250" y="573.2695">lock timeout but not actually dead</text><polygon fill="#181818" points="512,606.9004,522,610.9004,512,614.9004,516,610.9004" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="152" x2="518" y1="610.9004" y2="610.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="159" y="606.1582">POST /webhook?ETag="1"&amp;dequeueCount=2</text><path d="M29,594.5898 L29,649.5898 L147,649.5898 L147,604.5898 L137,594.5898 L29,594.5898 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M137,594.5898 L137,604.5898 L147,604.5898 L137,594.5898 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="35" y="612.1582">dequeueCount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="35" y="627.4688">warns Update 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="35" y="642.7793">is pending</text><path d="M471.5,660.5215 L471.5,685.5215 L586.5,685.5215 L586.5,670.5215 L576.5,660.5215 L471.5,660.5215 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M576.5,660.5215 L576.5,670.5215 L586.5,670.5215 L576.5,660.5215 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="477.5" y="678.0898">ignore warning</text><line style="stroke:#181818;stroke-width:1.0;" x1="534" x2="576" y1="712.1426" y2="712.1426"/><line style="stroke:#181818;stroke-width:1.0;" x1="576" x2="576" y1="712.1426" y2="725.1426"/><line style="stroke:#181818;stroke-width:1.0;" x1="535" x2="576" y1="725.1426" y2="725.1426"/><polygon fill="#181818" points="545,721.1426,535,725.1426,545,729.1426,541,725.1426" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="541" y="707.4004">process Update 1</text><path d="M368,695.832 L368,735.832 L524,735.832 L524,705.832 L514,695.832 L368,695.832 " fill="#FFC0CB" style="stroke:#181818;stroke-width:0.5;"/><path d="M514,695.832 L514,705.832 L524,705.832 L514,695.832 " fill="#FFC0CB" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="374" y="713.4004">duplicate processing!</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="374" y="728.7109">(OK if idempotent)</text><polygon fill="#181818" points="168,758.7637,158,762.7637,168,766.7637,164,762.7637" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="523" y1="762.7637" y2="762.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="174" y="758.0215">DELETE ~/state/lock If-Match: "1"</text><polygon fill="#181818" points="512,788.0742,522,792.0742,512,796.0742,516,792.0742" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="518" y1="792.0742" y2="792.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="164" y="787.332">200 OK</text><polygon fill="#181818" points="168,845.3848,158,849.3848,168,853.3848,164,849.3848" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="162" x2="395" y1="849.3848" y2="849.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="174" y="844.6426">DELETE ~/state/lock If-Match: "1"</text><polygon fill="#181818" points="384,874.6953,394,878.6953,384,882.6953,388,878.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="157" x2="390" y1="878.6953" y2="878.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="164" y="873.9531">404 Not Found</text><!--MD5=[fb8c305df19a54b35c24d36a41ce5a92]
@startuml
'https://plantuml.com/sequence-diagram
!pragma teoz true
hide footbox

title More Concurrent Cases

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group concurrent write & poll [happy]
activate app
app -> gw ++: POST \~/state { ... }
return 200 OK ETag: "1" Update 1
app -> app: process Update 1
activate app2
app2 -> gw ++: GET /updates
note over gw
Update 1 is
pending
end note
return 425 Too Early
deactivate app2
app -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app
end group

group timeout write processing [unhappy]
activate app
app -> gw ++: POST \~/state { ... }
return 200 OK: Update 1
app -> app: process Update 1
...lock timeout but not actually dead...
gw -> app2 ++: POST /webhook?ETag="1"&dequeueCount=2
note left
dequeueCount
warns Update 1
is pending
end note
note over app2: ignore warning
app2 -> app2: process Update 1
note left #pink
duplicate processing!
(OK if idempotent)
end note
app2 -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app2
...
app -> gw ++: DELETE \~/state/lock If-Match: "1"
return 404 Not Found
deactivate app
end group

@enduml

@startuml
!pragma teoz true
hide footbox

title More Concurrent Cases

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group concurrent write & poll [happy]
activate app
app -> gw ++: POST \~/state { ... }
return 200 OK ETag: "1" Update 1
app -> app: process Update 1
activate app2
app2 -> gw ++: GET /updates
note over gw
Update 1 is
pending
end note
return 425 Too Early
deactivate app2
app -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app
end group

group timeout write processing [unhappy]
activate app
app -> gw ++: POST \~/state { ... }
return 200 OK: Update 1
app -> app: process Update 1
...lock timeout but not actually dead...
gw -> app2 ++: POST /webhook?ETag="1"&dequeueCount=2
note left
dequeueCount
warns Update 1
is pending
end note
note over app2: ignore warning
app2 -> app2: process Update 1
note left #pink
duplicate processing!
(OK if idempotent)
end note
app2 -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app2
...
app -> gw ++: DELETE \~/state/lock If-Match: "1"
return 404 Not Found
deactivate app
end group

@enduml

PlantUML version 1.2022.8(Sun Sep 25 10:00:33 BST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>