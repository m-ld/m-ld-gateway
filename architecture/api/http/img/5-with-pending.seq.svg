<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg"
     contentStyleType="text/css" height="762px" preserveAspectRatio="none"
     style="width:688px;height:762px;background:#FFFFFF;" version="1.1" viewBox="0 0 688 762"
     width="688px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="712.6309" style="stroke:#181818;stroke-width:0.5;" width="182" x="454" y="43.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="531" y="56.0566">App</text><rect fill="none" height="26.4883" id="_title" style="stroke:none;stroke-width:1.0;" width="218" x="257.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="208" x="262.5" y="28.5352">Concurrent Write and Update</text><rect fill="none" height="188.1738" style="stroke:#000000;stroke-width:1.5;" width="674" x="8" y="106.2871"/><rect fill="none" height="413.6582" style="stroke:#000000;stroke-width:1.5;" width="674" x="8" y="312.4609"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="122" x2="122" y1="94.2871" y2="750.1191"/><rect fill="#FFFFFF" height="42.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="154.9082"/><rect fill="#FFFFFF" height="72.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="213.5293"/><rect fill="#FFFFFF" height="42.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="361.082"/><rect fill="#FFFFFF" height="182.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="419.7031"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="688.8086"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="122" y="527.9453"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="499" x2="499" y1="94.2871" y2="750.1191"/><rect fill="#FFFFFF" height="107.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="494" y="192.2188"/><rect fill="#FFFFFF" height="332.7266" style="stroke:#181818;stroke-width:1.0;" width="10" x="494" y="398.3926"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="591" x2="591" y1="94.2871" y2="750.1191"/><rect fill="#FFFFFF" height="115.2422" style="stroke:#181818;stroke-width:1.0;" width="10" x="586" y="184.2188"/><rect fill="#FFFFFF" height="179.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="586" y="390.3926"/><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="86.5" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="93.5" y="83.334">Gateway</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="458" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="465" y="83.334">(thread 1)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="550" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="557" y="83.334">(thread 2)</text><path d="M8,106.2871 L198,106.2871 L198,113.5977 L188,123.5977 L8,123.5977 L8,106.2871 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="188.1738" style="stroke:#000000;stroke-width:1.5;" width="674" x="8" y="106.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="145" x="23" y="119.8555">write to expected tick</text><polygon fill="#181818" points="105,150.9082,115,154.9082,105,158.9082,109,154.9082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="5" x2="111" y1="154.9082" y2="154.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="12" y="150.166">Operation 1</text><polygon fill="#181818" points="574,180.2188,584,184.2188,574,188.2188,578,184.2188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="127" x2="580" y1="184.2188" y2="184.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382" x="134" y="179.4766">POST /webhook?ETag="1"&amp;Location=~/state?lock [Update 1]</text><line style="stroke:#181818;stroke-width:1.0;" x1="596" x2="638" y1="228.8398" y2="228.8398"/><line style="stroke:#181818;stroke-width:1.0;" x1="638" x2="638" y1="228.8398" y2="241.8398"/><line style="stroke:#181818;stroke-width:1.0;" x1="597" x2="638" y1="241.8398" y2="241.8398"/><polygon fill="#181818" points="607,237.8398,597,241.8398,607,245.8398,603,241.8398" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="603" y="208.7871">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="603" y="224.0977">Update 1</text><polygon fill="#181818" points="138,227.3398,128,231.3398,138,235.3398,134,231.3398" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="493" y1="231.3398" y2="231.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="144" y="226.5977">POST ~/state If-Match: "0" { ... }</text><polygon fill="#181818" points="482,282.4609,492,286.4609,482,290.4609,486,286.4609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="488" y1="286.4609" y2="286.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="134" y="266.4082">412 Precondition Failed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="134" y="281.7188">(Update 1 is pending)</text><path d="M8,312.4609 L194,312.4609 L194,319.7715 L184,329.7715 L8,329.7715 L8,312.4609 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="413.6582" style="stroke:#000000;stroke-width:1.5;" width="674" x="8" y="312.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141" x="23" y="326.0293">write to wildcard tick</text><polygon fill="#181818" points="105,357.082,115,361.082,105,365.082,109,361.082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="5" x2="111" y1="361.082" y2="361.082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="12" y="356.3398">Operation 1</text><polygon fill="#181818" points="574,386.3926,584,390.3926,574,394.3926,578,390.3926" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="127" x2="580" y1="390.3926" y2="390.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="382" x="134" y="385.6504">POST /webhook?ETag="1"&amp;Location=~/state?lock [Update 1]</text><line style="stroke:#181818;stroke-width:1.0;" x1="596" x2="638" y1="435.0137" y2="435.0137"/><line style="stroke:#181818;stroke-width:1.0;" x1="638" x2="638" y1="435.0137" y2="448.0137"/><line style="stroke:#181818;stroke-width:1.0;" x1="597" x2="638" y1="448.0137" y2="448.0137"/><polygon fill="#181818" points="607,444.0137,597,448.0137,607,452.0137,603,448.0137" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="603" y="414.9609">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="603" y="430.2715">Update 1</text><polygon fill="#181818" points="138,433.5137,128,437.5137,138,441.5137,134,437.5137" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="493" y1="437.5137" y2="437.5137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="144" y="432.7715">POST ~/state?lock { ... }</text><path d="M61,461.0137 L61,501.0137 L183,501.0137 L183,471.0137 L173,461.0137 L61,461.0137 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M173,461.0137 L173,471.0137 L183,471.0137 L173,461.0137 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="67" y="478.582">write is delayed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="67" y="493.8926">by pending lock</text><polygon fill="#181818" points="143,523.9453,133,527.9453,143,531.9453,139,527.9453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="137" x2="585" y1="527.9453" y2="527.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="149" y="523.2031">DELETE ~/state?lock If-Match: "1"</text><polygon fill="#181818" points="574,553.2559,584,557.2559,574,561.2559,578,557.2559" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="132" x2="580" y1="557.2559" y2="557.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="139" y="552.5137">200 OK</text><polygon fill="#181818" points="482,597.877,492,601.877,482,605.877,486,601.877" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="488" y1="601.877" y2="601.877"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="348" x="134" y="581.8242">201 Created ETag: "2" Location: ~/state?lock {Update 2}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="13" x="134" y="597.1348">or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="151" y="597.1348">408 Request Timeout</text><line style="stroke:#181818;stroke-width:1.0;" x1="504" x2="546" y1="646.498" y2="646.498"/><line style="stroke:#181818;stroke-width:1.0;" x1="546" x2="546" y1="646.498" y2="659.498"/><line style="stroke:#181818;stroke-width:1.0;" x1="505" x2="546" y1="659.498" y2="659.498"/><polygon fill="#181818" points="515,655.498,505,659.498,515,663.498,511,659.498" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="511" y="626.4453">process</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="511" y="641.7559">Update 2</text><polygon fill="#181818" points="138,684.8086,128,688.8086,138,692.8086,134,688.8086" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="493" y1="688.8086" y2="688.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="144" y="684.0664">DELETE ~/state?lock If-Match: "2"</text><polygon fill="#181818" points="482,714.1191,492,718.1191,482,722.1191,486,718.1191" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="488" y1="718.1191" y2="718.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="134" y="713.377">200 OK</text><!--MD5=[aadf93f82e80607d87866f49ef4e8f50]
@startuml
'https://plantuml.com/sequence-diagram
!pragma teoz true
hide footbox

title: Concurrent Write and Update

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group write to expected tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1"&Location=\~/state?lock [Update 1]
app2 -> app2: process\nUpdate 1
activate app
& app -> gw ++: POST \~/state If-Match: "0" { ... }
return 412 Precondition Failed\n(Update 1 is pending)
deactivate app
deactivate app2
end group

group write to wildcard tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1"&Location=\~/state?lock [Update 1]
app2 -> app2: process\nUpdate 1
activate app
& app -> gw ++: POST \~/state?lock { ... }
note over gw
write is delayed
by pending lock
end note
app2 -> gw ++: DELETE \~/state?lock If-Match: "1"
return 200 OK
deactivate app2
gw - -> app: 201 Created ETag: "2" Location: \~/state?lock {Update 2}\n//or// 408 Request Timeout
deactivate gw
app -> app: process\nUpdate 2
app -> gw ++: DELETE \~/state?lock If-Match: "2"
return 200 OK
deactivate app
end group

@enduml

@startuml
!pragma teoz true
hide footbox

title: Concurrent Write and Update

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group write to expected tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1"&Location=\~/state?lock [Update 1]
app2 -> app2: process\nUpdate 1
activate app
& app -> gw ++: POST \~/state If-Match: "0" { ... }
return 412 Precondition Failed\n(Update 1 is pending)
deactivate app
deactivate app2
end group

group write to wildcard tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1"&Location=\~/state?lock [Update 1]
app2 -> app2: process\nUpdate 1
activate app
& app -> gw ++: POST \~/state?lock { ... }
note over gw
write is delayed
by pending lock
end note
app2 -> gw ++: DELETE \~/state?lock If-Match: "1"
return 200 OK
deactivate app2
gw - -> app: 201 Created ETag: "2" Location: \~/state?lock {Update 2}\n//or// 408 Request Timeout
deactivate gw
app -> app: process\nUpdate 2
app -> gw ++: DELETE \~/state?lock If-Match: "2"
return 200 OK
deactivate app
end group

@enduml

PlantUML version 1.2022.8(Sun Sep 25 10:00:33 BST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>