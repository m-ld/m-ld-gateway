<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg"
     contentStyleType="text/css" height="749px" preserveAspectRatio="none"
     style="width:542px;height:749px;background:#FFFFFF;" version="1.1" viewBox="0 0 542 749"
     width="542px" zoomAndPan="magnify"><defs/><g><rect fill="#DDDDDD" height="699.6309" style="stroke:#181818;stroke-width:0.5;" width="182" x="326" y="43.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="403" y="56.0566">App</text><rect fill="none" height="26.4883" id="_title" style="stroke:none;stroke-width:1.0;" width="218" x="184.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="208" x="189.5" y="28.5352">Concurrent Write and Update</text><rect fill="none" height="210.4844" style="stroke:#000000;stroke-width:1.5;" width="528" x="8" y="106.2871"/><rect fill="none" height="378.3477" style="stroke:#000000;stroke-width:1.5;" width="528" x="8" y="334.7715"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="122" x2="122" y1="94.2871" y2="737.1191"/><rect fill="#FFFFFF" height="42.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="154.9082"/><rect fill="#FFFFFF" height="44.6211" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="264.1504"/><rect fill="#FFFFFF" height="42.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="383.3926"/><rect fill="#FFFFFF" height="153.8633" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="492.6348"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="117" y="675.8086"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#181818;stroke-width:1.0;" width="10" x="122" y="572.5664"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="371" x2="371" y1="94.2871" y2="737.1191"/><rect fill="#FFFFFF" height="78.9316" style="stroke:#181818;stroke-width:1.0;" width="10" x="366" y="242.8398"/><rect fill="#FFFFFF" height="246.7949" style="stroke:#181818;stroke-width:1.0;" width="10" x="366" y="471.3242"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="463" x2="463" y1="94.2871" y2="737.1191"/><rect fill="#FFFFFF" height="137.5527" style="stroke:#181818;stroke-width:1.0;" width="10" x="458" y="184.2188"/><rect fill="#FFFFFF" height="202.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="458" y="412.7031"/><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="71" x="86.5" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="93.5" y="83.334">Gateway</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="330" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="337" y="83.334">(thread 1)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="422" y="62.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="429" y="83.334">(thread 2)</text><path d="M8,106.2871 L198,106.2871 L198,113.5977 L188,123.5977 L8,123.5977 L8,106.2871 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="210.4844" style="stroke:#000000;stroke-width:1.5;" width="528" x="8" y="106.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="145" x="23" y="119.8555">write to expected tick</text><polygon fill="#181818" points="105,150.9082,115,154.9082,105,158.9082,109,154.9082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="5" x2="111" y1="154.9082" y2="154.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="12" y="150.166">Operation 1</text><polygon fill="#181818" points="446,180.2188,456,184.2188,446,188.2188,450,184.2188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="127" x2="452" y1="184.2188" y2="184.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="134" y="179.4766">POST /webhook?ETag="1" [Update 1]</text><path d="M411,197.2188 L411,237.2188 L515,237.2188 L515,207.2188 L505,197.2188 L411,197.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M505,197.2188 L505,207.2188 L515,207.2188 L505,197.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="417" y="214.7871">Update being</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="417" y="230.0977">processed</text><polygon fill="#181818" points="138,260.1504,128,264.1504,138,268.1504,134,264.1504" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="365" y1="264.1504" y2="264.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="144" y="259.4082">POST ~/state If-Match: "0" { ... }</text><polygon fill="#181818" points="354,304.7715,364,308.7715,354,312.7715,358,308.7715" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="360" y1="308.7715" y2="308.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="134" y="288.7188">412 Precondition Failed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="134" y="304.0293">(Update 1 is pending)</text><path d="M8,334.7715 L194,334.7715 L194,342.082 L184,352.082 L8,352.082 L8,334.7715 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="378.3477" style="stroke:#000000;stroke-width:1.5;" width="528" x="8" y="334.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141" x="23" y="348.3398">write to wildcard tick</text><polygon fill="#181818" points="105,379.3926,115,383.3926,105,387.3926,109,383.3926" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="5" x2="111" y1="383.3926" y2="383.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="12" y="378.6504">Operation 1</text><polygon fill="#181818" points="446,408.7031,456,412.7031,446,416.7031,450,412.7031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="127" x2="452" y1="412.7031" y2="412.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="134" y="407.9609">POST /webhook?ETag="1" [Update 1]</text><path d="M411,425.7031 L411,465.7031 L515,465.7031 L515,435.7031 L505,425.7031 L411,425.7031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M505,425.7031 L505,435.7031 L515,435.7031 L505,425.7031 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="417" y="443.2715">Update being</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="417" y="458.582">processed</text><polygon fill="#181818" points="138,488.6348,128,492.6348,138,496.6348,134,492.6348" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="365" y1="492.6348" y2="492.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="144" y="487.8926">POST ~ { ... }</text><path d="M52.5,505.6348 L52.5,545.6348 L191.5,545.6348 L191.5,515.6348 L181.5,505.6348 L52.5,505.6348 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M181.5,505.6348 L181.5,515.6348 L191.5,515.6348 L181.5,505.6348 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="58.5" y="523.2031">write is delayed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="58.5" y="538.5137">by pending Update</text><polygon fill="#181818" points="143,568.5664,133,572.5664,143,576.5664,139,572.5664" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="137" x2="457" y1="572.5664" y2="572.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="149" y="567.8242">DELETE ~/state/lock If-Match: "1"</text><polygon fill="#181818" points="446,597.877,456,601.877,446,605.877,450,601.877" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="132" x2="452" y1="601.877" y2="601.877"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="139" y="597.1348">200 OK</text><polygon fill="#181818" points="354,642.498,364,646.498,354,650.498,358,646.498" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="360" y1="646.498" y2="646.498"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="134" y="626.4453">200 OK: Update 2</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="13" x="134" y="641.7559">or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="151" y="641.7559">408 Request Timeout</text><polygon fill="#181818" points="138,671.8086,128,675.8086,138,679.8086,134,675.8086" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="132" x2="365" y1="675.8086" y2="675.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="144" y="671.0664">DELETE ~/state/lock If-Match: "2"</text><polygon fill="#181818" points="354,701.1191,364,705.1191,354,709.1191,358,705.1191" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="127" x2="360" y1="705.1191" y2="705.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="134" y="700.377">200 OK</text><!--MD5=[9f685eca63d47dd96bcb165ada0f3f19]
@startuml
'https://plantuml.com/sequence-diagram
!pragma teoz true
hide footbox

title: Concurrent Write and Update

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group write to expected tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1" [Update 1]
note over app2: Update being\nprocessed
activate app
app -> gw ++: POST \~/state If-Match: "0" { ... }
return 412 Precondition Failed\n(Update 1 is pending)
deactivate app
deactivate app2
end group

group write to wildcard tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1" [Update 1]
note over app2: Update being\nprocessed
activate app
app -> gw ++: POST \~ { ... }
note over gw
write is delayed
by pending Update
end note
app2 -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app2
gw - -> app: 200 OK: Update 2\n//or// 408 Request Timeout
deactivate gw
app -> gw ++: DELETE \~/state/lock If-Match: "2"
return 200 OK
deactivate app
end group

@enduml

@startuml
!pragma teoz true
hide footbox

title: Concurrent Write and Update

participant Gateway as gw
box App
participant "(thread 1)" as app
participant "(thread 2)" as app2
end box

group write to expected tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1" [Update 1]
note over app2: Update being\nprocessed
activate app
app -> gw ++: POST \~/state If-Match: "0" { ... }
return 412 Precondition Failed\n(Update 1 is pending)
deactivate app
deactivate app2
end group

group write to wildcard tick
-> gw ++: Operation 1
gw -> app2 ++- -: POST /webhook?ETag="1" [Update 1]
note over app2: Update being\nprocessed
activate app
app -> gw ++: POST \~ { ... }
note over gw
write is delayed
by pending Update
end note
app2 -> gw ++: DELETE \~/state/lock If-Match: "1"
return 200 OK
deactivate app2
gw - -> app: 200 OK: Update 2\n//or// 408 Request Timeout
deactivate gw
app -> gw ++: DELETE \~/state/lock If-Match: "2"
return 200 OK
deactivate app
end group

@enduml

PlantUML version 1.2022.8(Sun Sep 25 10:00:33 BST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>